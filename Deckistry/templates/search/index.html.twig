{% extends 'base.html.twig' %}

{% block title %}Recherche de cartes - Deckistry{% endblock %}

{% block importmap %}
    {{ parent() }}
    {{ importmap('search') }}
{% endblock %}

{% block body %}
<div class="search-page">
    <div class="container">
        <div class="search-layout">
            {# Left Sidebar - Advanced Filters #}
            <aside class="search-filters">
                <h2 class="filters-title">üîç Recherche</h2>
                
                <form method="get" action="{{ path('app_search') }}" class="search-form">
                    <div class="search-input-section">
                        <input 
                            type="text" 
                            name="q" 
                            value="{{ query }}" 
                            placeholder="Super carte"
                            class="filter-input"
                            autocomplete="off"
                            id="searchInput"
                            data-autocomplete-url="{{ path('api_cards_autocomplete') }}"
                        >
                        <div id="searchSuggestions" class="search-suggestions"></div>
                        <button type="submit" class="btn btn-accent btn-search">Rechercher</button>
                    </div>

                {# Advanced Filters Section #}
                <div class="filter-section">
                    <h3 class="filter-section-title">
                        <button type="button" class="filter-toggle active" data-target="advanced-filters">
                            <span>‚ñº</span> Recherche avanc√©es
                        </button>
                    </h3>
                    <div class="filter-content active" id="advanced-filters">
                        {# Language Filter #}
                        <div class="filter-group">
                            <label class="filter-label">Langue</label>
                            <select name="lang" id="langFilter" class="filter-select">
                                <option value="en" {{ selected_lang == 'en' ? 'selected' : '' }}>üá¨üáß English</option>
                                <option value="es" {{ selected_lang == 'es' ? 'selected' : '' }}>üá™üá∏ Espa√±ol</option>
                                <option value="fr" {{ selected_lang == 'fr' ? 'selected' : '' }}>üá´üá∑ Fran√ßais</option>
                                <option value="de" {{ selected_lang == 'de' ? 'selected' : '' }}>üá©üá™ Deutsch</option>
                                <option value="it" {{ selected_lang == 'it' ? 'selected' : '' }}>üáÆüáπ Italiano</option>
                                <option value="pt" {{ selected_lang == 'pt' ? 'selected' : '' }}>üáµüáπ Portugu√™s</option>
                                <option value="ja" {{ selected_lang == 'ja' ? 'selected' : '' }}>üáØüáµ Êó•Êú¨Ë™û</option>
                                <option value="ko" {{ selected_lang == 'ko' ? 'selected' : '' }}>üá∞üá∑ ÌïúÍµ≠Ïñ¥</option>
                                <option value="ru" {{ selected_lang == 'ru' ? 'selected' : '' }}>üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                                <option value="zhs" {{ selected_lang == 'zhs' ? 'selected' : '' }}>üá®üá≥ ÁÆÄ‰Ωì‰∏≠Êñá</option>
                                <option value="zht" {{ selected_lang == 'zht' ? 'selected' : '' }}>üáπüáº ÁπÅÈ´î‰∏≠Êñá</option>
                                <option value="any" {{ selected_lang == 'any' ? 'selected' : '' }}>üåç Toutes les langues</option>
                            </select>
                        </div>
                        
                        {# Mana Colors #}
                        <div class="filter-group">
                            <label class="filter-label">Couleurs de mana</label>
                            <div class="logic-selector">
                                <label class="logic-option">
                                    <input type="radio" name="logic" value="or" {{ selected_logic == 'or' ? 'checked' : '' }}>
                                    <span>Ou</span>
                                </label>
                                <label class="logic-option">
                                    <input type="radio" name="logic" value="and" {{ selected_logic == 'and' ? 'checked' : '' }}>
                                    <span>Inclue</span>
                                </label>
                            </div>
                            <div class="mana-colors">
                                <button type="button" class="mana-btn" data-color="C" title="Incolore">
                                    <img src="{{ asset('icons/unncolor.webp') }}" alt="Incolore" class="mana-icon">
                                </button>
                                <button type="button" class="mana-btn" data-color="W" title="Blanc">
                                    <img src="{{ asset('icons/plain.webp') }}" alt="Blanc" class="mana-icon">
                                </button>
                                <button type="button" class="mana-btn" data-color="U" title="Bleu">
                                    <img src="{{ asset('icons/Island.webp') }}" alt="Bleu" class="mana-icon">
                                </button>
                                <button type="button" class="mana-btn" data-color="B" title="Noir">
                                    <img src="{{ asset('icons/Swamp.webp') }}" alt="Noir" class="mana-icon">
                                </button>
                                <button type="button" class="mana-btn" data-color="R" title="Rouge">
                                    <img src="{{ asset('icons/Mountain.webp') }}" alt="Rouge" class="mana-icon">
                                </button>
                                <button type="button" class="mana-btn" data-color="G" title="Vert">
                                    <img src="{{ asset('icons/Forest.webp') }}" alt="Vert" class="mana-icon">
                                </button>
                                <button type="button" class="mana-btn" data-color="M" title="Multicolore">
                                    <img src="{{ asset('icons/icone_Timeshifted.webp') }}" alt="Multicolore" class="mana-icon">
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                {# Editions Filter #}
                <div class="filter-section">
                    <h3 class="filter-section-title">
                        <button type="button" class="filter-toggle" data-target="editions-filter">
                            <span>‚ñ∂</span> √âditions
                        </button>
                    </h3>
                    <div class="filter-content" id="editions-filter">
                        <select name="set" class="filter-select">
                            <option value="">Toutes les √©ditions</option>
                            {% for set in sets %}
                                <option value="{{ set.code }}" {{ selected_set == set.code ? 'selected' : '' }}>{{ set.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                {# Rarity Filter #}
                <div class="filter-section">
                    <h3 class="filter-section-title">
                        <button type="button" class="filter-toggle active" data-target="rarity-filter">
                            <span>‚ñº</span> Raret√©
                        </button>
                    </h3>
                    <div class="filter-content active" id="rarity-filter">
                        <div class="rarity-options">
                            <label class="rarity-option">
                                <input type="checkbox" name="rarity[]" value="common">
                                <img src="{{ asset('icons/iconne_commune.webp') }}" alt="Commune" class="rarity-icon">
                                <span class="rarity-common">Commune</span>
                            </label>
                            <label class="rarity-option">
                                <input type="checkbox" name="rarity[]" value="uncommon">
                                <img src="{{ asset('icons/icone_unnco.webp') }}" alt="Peu commune" class="rarity-icon">
                                <span class="rarity-uncommon">Peu commune</span>
                            </label>
                            <label class="rarity-option">
                                <input type="checkbox" name="rarity[]" value="rare">
                                <img src="{{ asset('icons/icone_rare.webp') }}" alt="Rare" class="rarity-icon">
                                <span class="rarity-rare">Rare</span>
                            </label>
                            <label class="rarity-option">
                                <input type="checkbox" name="rarity[]" value="mythic">
                                <img src="{{ asset('icons/icone_mithyque.webp') }}" alt="Mythique" class="rarity-icon">
                                <span class="rarity-mythic">Mythique</span>
                            </label>
                        </div>
                    </div>
                </div>

                {# Card Type Filter #}
                <div class="filter-section">
                    <h3 class="filter-section-title">
                        <button type="button" class="filter-toggle active" data-target="type-filter">
                            <span>‚ñº</span> Type de cartes (ex: Cr√©ature)
                        </button>
                    </h3>
                    <div class="filter-content active" id="type-filter">
                        <div class="type-options">
                            <label class="type-option">
                                <input type="checkbox" name="type[]" value="creature">
                                <span>Cr√©ature</span>
                            </label>
                            <label class="type-option">
                                <input type="checkbox" name="type[]" value="planeswalker">
                                <span>Planeswalker</span>
                            </label>
                            <label class="type-option">
                                <input type="checkbox" name="type[]" value="instant">
                                <span>√âph√©m√®re</span>
                            </label>
                            <label class="type-option">
                                <input type="checkbox" name="type[]" value="sorcery">
                                <span>Rituel</span>
                            </label>
                            <label class="type-option">
                                <input type="checkbox" name="type[]" value="artifact">
                                <span>Artefact</span>
                            </label>
                            <label class="type-option">
                                <input type="checkbox" name="type[]" value="enchantment">
                                <span>Enchantement</span>
                            </label>
                            <label class="type-option">
                                <input type="checkbox" name="type[]" value="land">
                                <span>Terrain</span>
                            </label>
                        </div>
                    </div>
                </div>
                </form>
            </aside>

            {# Main Content Area #}
            <main class="search-content">
                {# Error Message #}
                {% if error %}
                    <div class="alert alert-danger">
                        {{ error }}
                    </div>
                {% endif %}

                {# Results Section #}
                {% if query or cards|length > 0 %}
                    {# Results Header #}
                    <div class="results-header">
                        <h2 class="results-title">
                            {% if cards|length > 0 %}
                                {{ total_cards }} carte(s) trouv√©e(s)
                            {% else %}
                                Aucune carte trouv√©e
                            {% endif %}
                        </h2>
                        
                        {% if cards|length > 0 %}
                            <div class="results-controls">
                                <select class="sort-select">
                                    <option value="name">Tri par nom</option>
                                    <option value="cmc">Tri par co√ªt</option>
                                    <option value="rarity">Tri par raret√©</option>
                                    <option value="price">Tri par prix</option>
                                </select>
                            </div>
                        {% endif %}
                    </div>

                    {# Cards Grid #}
                    {% if cards|length > 0 %}
                        <div class="cards-grid">
                            {% for card in cards %}
                                <div class="card-item">
                                    <div class="card-image-wrapper" data-card-id="{{ card.id }}">
                                        {% if card.getBestImageUri() %}
                                            <img 
                                                src="{{ card.getBestImageUri() }}" 
                                                alt="{{ card.name }}"
                                                class="card-image card-face-front"
                                                loading="lazy"
                                                data-front-image="{{ card.getBestImageUri() }}"
                                                {% if card.isDoubleFaced %}
                                                    data-back-image="{{ card.getBestBackImageUri() }}"
                                                {% endif %}
                                            >
                                        {% else %}
                                            <div class="card-placeholder">
                                                <span>Pas d'image</span>
                                            </div>
                                        {% endif %}
                                        
                                        {# Flip button for double-faced cards #}
                                        {% if card.isDoubleFaced %}
                                            <button class="btn-flip-card" onclick="flipCard('{{ card.id }}')" title="Retourner la carte">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                                                    <path d="M21 3v5h-5"/>
                                                    <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                                                    <path d="M3 21v-5h5"/>
                                                </svg>
                                            </button>
                                        {% endif %}
                                        
                                        <div class="card-overlay">
                                            <button class="btn btn-primary btn-sm" onclick="showCardPrints('{{ card.name }}', '{{ card.id }}')">
                                                üì¶ Versions
                                            </button>
                                            <button class="btn btn-primary btn-sm" onclick="addToCollection('{{ card.id }}')">
                                                + Collection
                                            </button>
                                            <a href="{{ card.scryfallUri }}" target="_blank" class="btn btn-secondary btn-sm">
                                                Scryfall
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <div class="card-info">
                                        <h3 class="card-name">{{ card.name }}</h3>
                                        
                                        {% if card.manaCost %}
                                            <div class="card-mana">{{ card.manaCost|mana_symbols }}</div>
                                        {% endif %}
                                        
                                        <p class="card-type">{{ card.typeLine }}</p>
                                        
                                        {% if card.getStats() %}
                                            <p class="card-stats">{{ card.getStats() }}</p>
                                        {% endif %}
                                        
                                        <div class="card-set">
                                            {{ card.setCode|upper }}
                                        </div>
                                        
                                        {% if card.eurPrice %}
                                            <div class="card-price">‚Ç¨{{ card.eurPrice }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                        {# Pagination #}
                        <div class="pagination">
                            {% if current_page > 1 %}
                                <a href="{{ path('app_search', {
                                    q: query, 
                                    page: current_page - 1,
                                    lang: selected_lang,
                                    logic: selected_logic,
                                    set: selected_set
                                }) }}" class="pagination-btn">
                                    ‚Üê Pr√©c√©dent
                                </a>
                            {% endif %}
                            
                            <span class="pagination-current">Page {{ current_page }}</span>
                            
                            {% if has_more %}
                                <a href="{{ path('app_search', {
                                    q: query, 
                                    page: current_page + 1,
                                    lang: selected_lang,
                                    logic: selected_logic,
                                    set: selected_set
                                }) }}" class="pagination-btn">
                                    Suivant ‚Üí
                                </a>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="no-results">
                            <div class="no-results-icon">üîç</div>
                            <h3>Aucune carte trouv√©e</h3>
                            <p>Essayez avec d'autres termes de recherche ou filtres</p>
                        </div>
                    {% endif %}
                {% else %}
                    {# Empty state #}
                    <div class="search-empty">
                        <div class="empty-icon">üé¥</div>
                        <h2>Recherchez des cartes Magic</h2>
                        <p>Utilisez les filtres √† gauche ou la barre de recherche pour trouver vos cartes</p>
                        
                        <div class="quick-searches">
                            <h3>Recherches populaires :</h3>
                            <div class="quick-search-grid">
                                <a href="{{ path('app_search', {q: 'lightning bolt'}) }}" class="quick-search-item">
                                    ‚ö° Lightning Bolt
                                </a>
                                <a href="{{ path('app_search', {q: 't:creature c:red'}) }}" class="quick-search-item">
                                    üî• Cr√©atures rouges
                                </a>
                                <a href="{{ path('app_search', {q: 't:planeswalker'}) }}" class="quick-search-item">
                                    üëë Planeswalkers
                                </a>
                                <a href="{{ path('app_search', {q: 't:legendary'}) }}" class="quick-search-item">
                                    ‚≠ê L√©gendaires
                                </a>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </main>
        </div>
    </div>
</div>

{# Modal for card prints/versions #}
<div id="cardPrintsModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
        <span class="modal-close" onclick="closeCardPrintsModal()">&times;</span>
        <h2 id="modalCardName" style="margin-bottom: 20px;"></h2>
        <div id="modalPrintsGrid" class="prints-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px;">
            <!-- Card prints will be loaded here -->
        </div>
    </div>
</div>

<style>
.modal {
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: #2c3e50;
    padding: 30px;
    border-radius: 12px;
    position: relative;
    color: #fff;
}

.modal-close {
    position: absolute;
    right: 20px;
    top: 15px;
    font-size: 35px;
    font-weight: bold;
    color: #aaa;
    cursor: pointer;
    transition: color 0.3s;
}

.modal-close:hover {
    color: #fff;
}

.prints-grid .print-item {
    background: #1a1d1e;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    transition: transform 0.3s;
}

.prints-grid .print-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.4);
}

.prints-grid .print-item img {
    width: 100%;
    border-radius: 8px;
    margin-bottom: 10px;
}

.prints-grid .print-info {
    font-size: 0.9rem;
    color: #aaa;
    margin: 5px 0;
}

.prints-grid .print-set {
    font-weight: bold;
    color: #4caf50;
    margin-bottom: 5px;
}

.prints-grid .print-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 10px;
}

.foil-checkbox {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: #fff;
    font-size: 0.9rem;
    margin-top: 8px;
}

.foil-checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.foil-checkbox label {
    cursor: pointer;
    user-select: none;
}
</style>

<script>
let currentLanguage = 'en';

// Restore selected filters from server-side data
const selectedColors = {{ selected_colors|json_encode|raw }};
const selectedTypes = {{ selected_types|json_encode|raw }};
const selectedRarities = {{ selected_rarities|json_encode|raw }};

// Restore mana color buttons state
document.addEventListener('DOMContentLoaded', function() {
    // Restore color buttons
    document.querySelectorAll('.mana-btn').forEach(btn => {
        const color = btn.getAttribute('data-color');
        if (selectedColors.includes(color)) {
            btn.classList.add('active');
        }
    });
    
    // Initialize current language
    currentLanguage = document.getElementById('langFilter')?.value || 'en';
});

// G√©rer le changement de langue
document.getElementById('langFilter')?.addEventListener('change', function() {
    currentLanguage = this.value;
    // Le formulaire se soumettra normalement et conservera tous les filtres
});

// Afficher toutes les versions d'une carte
async function showCardPrints(cardName, currentCardId) {
    const modal = document.getElementById('cardPrintsModal');
    const modalTitle = document.getElementById('modalCardName');
    const printsGrid = document.getElementById('modalPrintsGrid');
    
    modalTitle.textContent = `Versions de "${cardName}"`;
    printsGrid.innerHTML = '<p style="text-align:center;padding:40px;">Chargement...</p>';
    modal.style.display = 'flex';
    
    try {
        const lang = document.getElementById('langFilter')?.value || 'en';
        const response = await fetch(`/api/card-prints/${encodeURIComponent(cardName)}?lang=${lang}`);
        const data = await response.json();
        
        if (data.success && data.prints.length > 0) {
            printsGrid.innerHTML = data.prints.map(print => `
                <div class="print-item">
                    ${print.imageUriSmall ? 
                        `<img src="${print.imageUriSmall}" alt="${print.name}" loading="lazy">` :
                        '<div style="width:100%;height:280px;background:#34495e;display:flex;align-items:center;justify-content:center;">No Image</div>'
                    }
                    <div class="print-set">${print.setName} (${print.set.toUpperCase()})</div>
                    <div class="print-info">#${print.collectorNumber}</div>
                    <div class="print-info">${print.rarity}</div>
                    ${print.prices?.eur ? `<div class="print-info">‚Ç¨${print.prices.eur}</div>` : ''}
                    <div class="print-actions">
                        <label class="foil-checkbox">
                            <input type="checkbox" id="foil_${print.id}">
                            <span>‚ú® Foil</span>
                        </label>
                        <button class="btn btn-primary btn-sm" onclick="addToCollectionWithOptions('${print.id}', '${print.name}')">
                            + Collection
                        </button>
                    </div>
                </div>
            `).join('');
        } else {
            printsGrid.innerHTML = '<p style="text-align:center;padding:40px;">Aucune version trouv√©e</p>';
        }
    } catch (error) {
        console.error('Error loading card prints:', error);
        printsGrid.innerHTML = '<p style="text-align:center;padding:40px;color:#f44336;">Erreur lors du chargement des versions</p>';
    }
}

function closeCardPrintsModal() {
    document.getElementById('cardPrintsModal').style.display = 'none';
}

// Fermer la modale en cliquant en dehors
document.getElementById('cardPrintsModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeCardPrintsModal();
    }
});

// Ajouter √† la collection avec options (foil, etc.)
async function addToCollectionWithOptions(cardId, cardName) {
    const foilCheckbox = document.getElementById(`foil_${cardId}`);
    const isFoil = foilCheckbox ? foilCheckbox.checked : false;
    
    try {
        const response = await fetch('/api/collection/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                scryfallId: cardId,
                quantity: 1,
                isFoil: isFoil
            })
        });

        const data = await response.json();

        if (data.success) {
            alert(`${cardName}${isFoil ? ' (Foil)' : ''} ajout√©e √† votre collection !`);
        } else {
            alert('Erreur: ' + (data.error || 'Impossible d\'ajouter la carte'));
        }
    } catch (error) {
        console.error('Error adding to collection:', error);
        alert('Erreur lors de l\'ajout √† la collection');
    }
}

// Recherche avec langue
async function performSearch(query, lang = 'en') {
    // Cette fonction peut √™tre utilis√©e pour rechercher avec la langue s√©lectionn√©e
    // Pour l'instant, le formulaire se soumet normalement
    console.log('Searching for:', query, 'in language:', lang);
}
</script>
{% endblock %}
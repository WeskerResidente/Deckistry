{% extends 'base.html.twig' %}

{% block title %}{{ deck.name }}{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        // D√©finir les variables globales avant le chargement de deck-builder.js
        window.deckId = {{ deck.id }};
        window.deckFormat = '{{ deck.format }}';
        window.isPrivate = {{ deck.isPrivate ? 'true' : 'false' }};
    </script>
    {{ encore_entry_script_tags('deck-builder') }}
{% endblock %}

{% block body %}
<!-- Barre de recherche rapide style Archidekt (hors de deck-edit-page) -->
<div class="quick-search-bar">
    <div class="quick-search-content">
        <button class="quick-search-tab active" onclick="openQuickAddModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            Recherche de cartes
        </button>
        <button class="quick-search-tab" onclick="openQuickAddModal()">
            Ajout rapide (Ctrl + ')
        </button>
        <input 
            type="text" 
            class="quick-search-input" 
            placeholder="Sol Ring (Ctrl + ')"
            id="quick-search-input"
            onfocus="openQuickAddModal()">
        <button class="quick-search-settings">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6"></path>
                <path d="m1 12 6 0m6 0 6 0"></path>
            </svg>
        </button>
    </div>
</div>

<div class="deck-edit-page">
    <div class="deck-edit-header">
        <div class="deck-info">
            <h1>{{ deck.name }}</h1>
            <div class="deck-meta">
                <span class="deck-format">{{ deck.format }}</span>
                <span class="deck-count">
                    <span class="card-count" id="total-cards">0</span> carte{% if deck.deckCards|length > 1 %}s{% endif %}
                </span>
                <button class="btn btn-icon" id="privacy-toggle" onclick="togglePrivacy()" title="Changer la visibilit√©">
                    {% if deck.isPrivate %}
                        <span class="badge badge-warning">üîí Priv√©</span>
                    {% else %}
                        <span class="badge badge-success">üåç Public</span>
                    {% endif %}
                </button>
                <button class="btn btn-icon" onclick="toggleShareMenu()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="18" cy="5" r="3"></circle>
                        <circle cx="6" cy="12" r="3"></circle>
                        <circle cx="18" cy="19" r="3"></circle>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                    </svg>
                    Partager
                </button>
                <button class="btn btn-icon" onclick="window.location.href='{{ path('app_deck_view', {username: deck.user.username, slug: deck.slug}) }}'">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                </button>
                <button class="btn btn-primary" onclick="window.location.href='{{ path('app_deck_edit', {username: deck.user.username, slug: deck.slug}) }}'">Modifier</button>
                <button class="btn btn-success" onclick="saveDeck(); return false;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Sauvegarder
                </button>
                <button class="btn btn-success" onclick="validateDeck()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Valider le deck
                </button>
            </div>
        </div>
    </div>

    <div class="deck-builder-container">
        <!-- Zone de recherche -->
        <div class="deck-search-panel">
            <div class="search-header">
                <h3>Rechercher une carte</h3>
                <button class="btn btn-secondary" onclick="openImportModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Importer des cartes
                </button>
                <button class="btn btn-primary" onclick="openQuickAddModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Recherche rapide
                </button>
            </div>
            
            <div class="search-controls">
                <input 
                    type="text" 
                    id="card-search-input" 
                    class="form-control" 
                    placeholder="Rechercher une carte"
                    autocomplete="off"
                >
                
                <div class="filter-group">
                    <label>Trie</label>
                    <select id="sort-select" class="form-select">
                        <option value="name">Nom</option>
                        <option value="cmc">CMC</option>
                        <option value="rarity">Raret√©</option>
                    </select>
                </div>

                <div class="filter-categories">
                    <button class="filter-btn" data-filter="creature">
                        <span class="filter-icon">üßô</span>
                        Cr√©ature
                    </button>
                    <button class="filter-btn" data-filter="instant">
                        <span class="filter-icon">‚ö°</span>
                        Instant
                    </button>
                    <button class="filter-btn" data-filter="sorcery">
                        <span class="filter-icon">üîÆ</span>
                        Sorcery
                    </button>
                    <button class="filter-btn" data-filter="enchantment">
                        <span class="filter-icon">‚ú®</span>
                        Enchant.
                    </button>
                    <button class="filter-btn" data-filter="artifact">
                        <span class="filter-icon">‚öôÔ∏è</span>
                        Artifact
                    </button>
                    <button class="filter-btn" data-filter="land">
                        <span class="filter-icon">üèîÔ∏è</span>
                        Terrain
                    </button>
                </div>

                <div class="color-filters">
                    <label>Couleur</label>
                    <div class="color-buttons">
                        <button class="color-btn" data-color="W" title="Blanc">W</button>
                        <button class="color-btn" data-color="U" title="Bleu">U</button>
                        <button class="color-btn" data-color="B" title="Noir">B</button>
                        <button class="color-btn" data-color="R" title="Rouge">R</button>
                        <button class="color-btn" data-color="G" title="Vert">G</button>
                    </div>
                </div>

                <button class="btn btn-secondary btn-block" onclick="clearFilters()">R√©initialiser</button>
            </div>

            <div id="search-results" class="search-results">
                <!-- R√©sultats de recherche -->
            </div>
        </div>

        <!-- Zone du deck -->
        <div class="deck-content-panel">
            <div class="deck-tabs">
                <button class="tab-btn active" data-tab="commander" {% if deck.format != 'Commander' %}style="display:none"{% endif %}>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    Commander
                </button>
                <button class="tab-btn" data-tab="deck">Deck</button>
                <button class="tab-btn" data-tab="stats">Statistiques</button>
            </div>

            <div class="deck-panels">
                <!-- Panel Commander -->
                <div class="deck-panel active" id="panel-commander" {% if deck.format != 'Commander' %}style="display:none"{% endif %}>
                    <div class="commander-zone" id="commander-zone">
                        <div class="commander-placeholder">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="16"></line>
                                <line x1="8" y1="12" x2="16" y2="12"></line>
                            </svg>
                            <p>Ajoutez votre commander</p>
                            <small>Une cr√©ature ou un v√©hicule l√©gendaire</small>
                        </div>
                    </div>
                </div>

                <!-- Panel Deck -->
                <div class="deck-panel" id="panel-deck">
                    <div class="deck-list" id="deck-list">
                        <div class="empty-deck">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                <line x1="8" y1="21" x2="16" y2="21"></line>
                                <line x1="12" y1="17" x2="12" y2="21"></line>
                            </svg>
                            <p>Votre deck est vide</p>
                            <small>Recherchez et ajoutez des cartes</small>
                        </div>
                    </div>
                </div>

                <!-- Panel Statistiques -->
                <div class="deck-panel" id="panel-stats">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h4>Courbe de mana</h4>
                            <canvas id="mana-curve-chart"></canvas>
                        </div>
                        <div class="stat-card">
                            <h4>R√©partition des types</h4>
                            <canvas id="type-chart"></canvas>
                        </div>
                        <div class="stat-card">
                            <h4>Couleurs</h4>
                            <div class="color-distribution" id="color-distribution"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modale d'ajout rapide -->
<div class="modal" id="quick-add-modal">
    <div class="modal-overlay" onclick="closeQuickAddModal()"></div>
    <div class="modal-content quick-add-modal-content">
        <div class="modal-header">
            <h3>Recherche de cartes</h3>
            <button class="modal-close" onclick="closeQuickAddModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        
        <div class="modal-body">
            <!-- Tabs de recherche -->
            <div class="search-tabs">
                <button class="search-tab active" data-search-type="archidekt">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Recherche
                </button>
                <button class="search-tab" data-search-type="syntax">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="4 17 10 11 4 5"></polyline>
                        <line x1="12" y1="19" x2="20" y2="19"></line>
                    </svg>
                    Recherche syntaxique
                </button>
            </div>

            <!-- Zone de recherche -->
            <div class="modal-search-area">
                <input 
                    type="text" 
                    class="modal-search-input" 
                    placeholder="Sol Ring"
                    id="modal-search-input"
                    autofocus>
                
                <!-- Options avanc√©es (masqu√©es par d√©faut) -->
                <div class="advanced-options" id="advanced-options" style="display: none;">
                    <div class="options-grid">
                        <div class="option-group">
                            <label>Filtres & Tri</label>
                            <!-- Options de filtre/tri -->
                        </div>
                    </div>
                </div>

                <button class="toggle-advanced" onclick="toggleAdvancedOptions()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                    Options avanc√©es
                </button>
            </div>

            <!-- R√©sultats de recherche -->
            <div class="modal-search-results" id="modal-search-results">
                <div class="search-results-header">
                    <span>Total: <strong id="modal-results-count">0</strong></span>
                    <div class="view-options">
                        <button class="view-btn active" data-view="grid">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <rect x="3" y="14" width="7" height="7"></rect>
                            </svg>
                        </button>
                        <button class="view-btn" data-view="list">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="8" y1="6" x2="21" y2="6"></line>
                                <line x1="8" y1="12" x2="21" y2="12"></line>
                                <line x1="8" y1="18" x2="21" y2="18"></line>
                                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                                <line x1="3" y1="18" x2="3.01" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="cards-grid" id="modal-cards-grid">
                    <p style="text-align: center; color: #999; padding: 40px;">Recherchez une carte pour commencer</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modale d'import de cartes -->
<div id="import-modal" class="import-modal-overlay">
    <div class="modal-dialog modal-lg">
        <div class="modal-header">
            <h3>Import Cards</h3>
            <button class="btn-close" onclick="closeImportModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="import-instructions">
                <details class="import-details">
                    <summary>‚ñ∂ Formatting Examples</summary>
                    <div class="import-examples">
                        <p><strong>Basic format:</strong></p>
                        <code>1x Sol Ring<br>1x Command Tower<br>98x Swamp</code>
                        
                        <p><strong>With set code:</strong></p>
                        <code>1x Sol Ring (c21)<br>1x Lightning Bolt (lea)</code>
                        
                        <p><strong>With tags:</strong></p>
                        <code>1x Sol Ring [Ramp]<br>1x Command Tower *F* [Removal]</code>
                        
                        <p><strong>Archidekt format:</strong></p>
                        <code>1x Sol Ring [Maybeboard]{noPrice}<br>1x Swamp *F* [Draw]</code>
                    </div>
                </details>
                
                <details class="import-details" open>
                    <summary>‚ñº Upload exported Archidekt file</summary>
                    <div class="import-upload">
                        <input type="file" id="import-file" accept=".txt,.csv" style="display: none;" onchange="handleFileImport(event)">
                        <button class="btn btn-secondary btn-block" onclick="document.getElementById('import-file').click()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            Choose File
                        </button>
                    </div>
                </details>
            </div>
            
            <textarea 
                id="import-text" 
                class="import-textarea" 
                placeholder="Paste your decklist here...&#10;&#10;Example:&#10;1x Sol Ring&#10;1x Command Tower&#10;98x Swamp"
                rows="15"></textarea>
            
            <div class="import-status" id="import-status" style="display: none;"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
            <button class="btn btn-primary" onclick="processImport()">Import Cards</button>
        </div>
    </div>
</div>

<script>
    async function togglePrivacy() {
        try {
            const response = await fetch(`/api/deck/${window.deckId}/toggle-privacy`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            if (result.success) {
                window.isPrivate = result.isPrivate;
                const button = document.getElementById('privacy-toggle');
                if (window.isPrivate) {
                    button.innerHTML = '<span class="badge badge-warning">üîí Priv√©</span>';
                } else {
                    button.innerHTML = '<span class="badge badge-success">üåç Public</span>';
                }
            }
        } catch (error) {
            console.error('Erreur lors du changement de visibilit√©:', error);
            alert('Erreur lors du changement de visibilit√©');
        }
    }
</script>
{% endblock %}
